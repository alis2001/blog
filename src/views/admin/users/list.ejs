<%- include('../partials/header') %>

<div class="admin-container">
  <div class="page-header">
    <h1>User Management</h1>
  </div>
  
  <% 
    const pendingUsers = users.filter(u => !u.isActive && !u.isMainAdmin);
    const activeUsers = users.filter(u => u.isActive || u.isMainAdmin);
  %>
  
  <% if (user.isMainAdmin && pendingUsers.length > 0) { %>
    <section class="user-section">
      <h2>Pending Approval (<%= pendingUsers.length %>)</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Registered</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% pendingUsers.forEach(u => { %>
            <tr>
              <td><%= u.email %></td>
              <td><span class="badge badge-draft"><%= u.role %></span></td>
              <td><%= new Date(u.createdAt).toLocaleDateString() %></td>
              <td class="actions">
                <button class="btn btn-sm btn-primary approve-user-btn" data-user-id="<%= u._id %>">Approve</button>
                <button class="btn btn-sm btn-danger reject-user-btn" data-user-id="<%= u._id %>">Reject</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
  <% } %>
  
  <section class="user-section">
    <h2>Active Users (<%= activeUsers.length %>)</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Approved By</th>
          <th>Last Login</th>
          <% if (user.isMainAdmin) { %>
            <th>Actions</th>
          <% } %>
        </tr>
      </thead>
      <tbody>
        <% activeUsers.forEach(u => { %>
          <tr>
            <td>
              <%= u.email %>
              <% if (u.isMainAdmin) { %>
                <span class="badge badge-featured" style="margin-left: 10px;">Main Admin</span>
              <% } %>
            </td>
            <td><span class="badge badge-published"><%= u.role %></span></td>
            <td>
              <span class="badge <%= u.isActive ? 'badge-published' : 'badge-archived' %>">
                <%= u.isActive ? 'Active' : 'Inactive' %>
              </span>
            </td>
            <td>
              <% if (u.isMainAdmin) { %>
                System
              <% } else if (u.approvedBy) { %>
                <%= u.approvedBy.email %>
              <% } else { %>
                -
              <% } %>
            </td>
            <td>
              <%= u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : 'Never' %>
            </td>
            <% if (user.isMainAdmin) { %>
              <td class="actions">
                <% if (!u.isMainAdmin) { %>
                  <% if (u.isActive) { %>
                    <button class="btn btn-sm btn-danger deactivate-user-btn" data-user-id="<%= u._id %>">Deactivate</button>
                  <% } else { %>
                    <button class="btn btn-sm btn-primary approve-user-btn" data-user-id="<%= u._id %>">Activate</button>
                  <% } %>
                <% } else { %>
                  -
                <% } %>
              </td>
            <% } %>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>
</div>

<style>
.user-section {
  margin-bottom: 50px;
}

.user-section h2 {
  font-size: 1.3rem;
  font-weight: 300;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 20px;
  color: #000000;
}

.alert-success {
  padding: 15px;
  margin-bottom: 20px;
  background: #ffffff;
  color: #000000;
  border: 1px solid #000000;
  font-weight: 300;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Approve user buttons
    document.querySelectorAll('.approve-user-btn').forEach(button => {
      button.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        approveUser(userId);
      });
    });
    
    // Reject user buttons
    document.querySelectorAll('.reject-user-btn').forEach(button => {
      button.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        rejectUser(userId);
      });
    });
    
    // Deactivate user buttons
    document.querySelectorAll('.deactivate-user-btn').forEach(button => {
      button.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        deactivateUser(userId);
      });
    });
  });
</script>

<%- include('../partials/footer') %>

