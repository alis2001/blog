<%- include('../partials/header') %>

<div class="admin-container">
  <div class="page-header">
    <h1>Edit Article</h1>
    <a href="/admin/articles" class="btn">Back to Articles</a>
  </div>
  
  <% if (errors && errors.length > 0) { %>
    <div class="alert alert-error">
      <ul>
        <% errors.forEach(error => { %>
          <li><%= error.msg %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>
  
  <form method="POST" action="/admin/articles/edit/<%= article._id %>" class="article-form" enctype="multipart/form-data">
    <div class="form-group">
      <label for="title">Title *</label>
      <input type="text" id="title" name="title" value="<%= article.title %>" required>
    </div>
    
    <div class="form-group">
      <label for="category">Category *</label>
      <select id="category" name="category" required>
        <option value="">Select a category</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>" <%= article.category._id.toString() === cat._id.toString() ? 'selected' : '' %>>
            <%= cat.name %>
          </option>
        <% }) %>
      </select>
    </div>
    
    <div class="form-group">
      <label for="excerpt">Excerpt</label>
      <textarea id="excerpt" name="excerpt" rows="3"><%= article.excerpt || '' %></textarea>
    </div>
    
    <div class="form-group">
      <label for="content">Content *</label>
      <textarea id="content" name="content" rows="15" required><%= article.content %></textarea>
    </div>
    
    <div class="form-group">
      <label for="featuredImage">Featured Image</label>
      <% if (article.featuredImage) { %>
        <div style="margin-bottom: 15px;">
          <img src="<%= article.featuredImage %>" alt="Current featured image" style="max-width: 300px; border: 1px solid #e5e5e5; padding: 10px;">
          <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">Current image</p>
        </div>
      <% } %>
      <input type="file" id="featuredImage" name="featuredImage" accept="image/*">
      <small>Upload a new image to replace the current one (JPG, PNG, GIF, WEBP - Max 5MB)</small>
    </div>
    
    <div class="form-group">
      <label for="tags">Tags</label>
      <input type="text" id="tags" name="tags" value="<%= article.tags ? article.tags.join(', ') : '' %>">
      <small>Comma-separated tags</small>
    </div>

    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e5e5e5;">
    
    <h3 style="margin-bottom: 10px; font-size: 1.2rem; font-weight: 300;">Source Information</h3>
    <p style="margin-bottom: 25px; font-size: 0.9rem; color: #666; font-style: italic;">
      Note: Enter the exact source name (e.g., BBC News, CNN, Reuters). This will be displayed publicly on the article with attribution.
    </p>
    
    <div class="form-group">
      <label for="sourceType">Content Type *</label>
      <select id="sourceType" name="sourceType">
        <option value="original" <%= !article.source || !article.source.type || article.source.type === 'original' ? 'selected' : '' %>>Original Content</option>
        <option value="sourced" <%= article.source && article.source.type === 'sourced' ? 'selected' : '' %>>Sourced from News Agency</option>
        <option value="aggregated" <%= article.source && article.source.type === 'aggregated' ? 'selected' : '' %>>Aggregated from Multiple Sources</option>
        <option value="translated" <%= article.source && article.source.type === 'translated' ? 'selected' : '' %>>Translated Content</option>
      </select>
      <small>Select the type of content for proper attribution</small>
    </div>

    <div class="form-group" id="sourceFields">
      <label for="sourceName">Source Name</label>
      <input type="text" id="sourceName" name="sourceName" value="<%= article.source && article.source.name ? article.source.name : '' %>" placeholder="e.g., BBC News, CNN, Reuters">
      <small>Name of the news agency or source</small>
    </div>

    <div class="form-group" id="sourceUrlField">
      <label for="sourceUrl">Source URL</label>
      <input type="url" id="sourceUrl" name="sourceUrl" value="<%= article.source && article.source.url ? article.source.url : '' %>" placeholder="https://...">
      <small>Link to the original article</small>
    </div>

    <div class="form-group" id="sourceAuthorField">
      <label for="sourceAuthor">Original Author</label>
      <input type="text" id="sourceAuthor" name="sourceAuthor" value="<%= article.source && article.source.author ? article.source.author : '' %>" placeholder="Author name from source">
      <small>Original author if available</small>
    </div>

    <div class="form-group" id="sourceDateField">
      <label for="sourceDate">Original Publish Date</label>
      <input type="date" id="sourceDate" name="sourceDate" value="<%= article.source && article.source.originalPublishDate ? new Date(article.source.originalPublishDate).toISOString().split('T')[0] : '' %>">
      <small>When the original article was published</small>
    </div>

    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e5e5e5;">
    
    <div class="form-group">
      <label for="status">Status *</label>
      <select id="status" name="status">
        <option value="draft" <%= article.status === 'draft' ? 'selected' : '' %>>Draft</option>
        <option value="published" <%= article.status === 'published' ? 'selected' : '' %>>Published</option>
        <option value="archived" <%= article.status === 'archived' ? 'selected' : '' %>>Archived</option>
      </select>
    </div>
    
    <div class="form-group checkbox">
      <label>
        <input type="checkbox" name="isFeatured" <%= article.isFeatured ? 'checked' : '' %>>
        Featured Article
      </label>
    </div>

    <script>
      document.getElementById('sourceType').addEventListener('change', function() {
        const sourceFields = document.getElementById('sourceFields');
        const sourceUrlField = document.getElementById('sourceUrlField');
        const sourceAuthorField = document.getElementById('sourceAuthorField');
        const sourceDateField = document.getElementById('sourceDateField');
        
        if (this.value === 'original') {
          sourceFields.style.display = 'none';
          sourceUrlField.style.display = 'none';
          sourceAuthorField.style.display = 'none';
          sourceDateField.style.display = 'none';
        } else {
          sourceFields.style.display = 'block';
          sourceUrlField.style.display = 'block';
          sourceAuthorField.style.display = 'block';
          sourceDateField.style.display = 'block';
        }
      });
      
      document.getElementById('sourceType').dispatchEvent(new Event('change'));
    </script>
    
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Update Article</button>
      <a href="/admin/articles" class="btn">Cancel</a>
    </div>
  </form>
</div>

<%- include('../partials/footer') %>

